# STM32 blink with HAL and Swift concurrency

This example project demonstrates the use of Swift concurrency combined with an STM32CubeMX-generated project using HAL. It targets the [NUCLEO-F411RE](https://www.st.com/en/evaluation-tools/nucleo-f411re.html) development board.

## Overview

This provides a cmake project for the [NUCLEO-F411RE](https://www.st.com/en/evaluation-tools/nucleo-f411re.html) development board, generated with STM32CubeMX based on default configuration. The following was added to the generated project:

- A custom pre-built armv7em-none-none-eabi swift-runtime, which is compiled against newlib/libstdc++ and includes the concurrency runtime. See [swift-runtime/README.md](swift-runtime/README.md)
- A [ContinuousClock](SwiftBlink/Support/ContinuousClock.swift) implementation that makes use of the standard 1 ms system timer provided by HAL.
- Functionality for supporting the ContinuousClock implementation, like [TaskletExecutor](SwiftBlink/Support/TaskletExecutor.swift) and [InterruptGuard](SwiftBlink/Support/InterruptGuard.swift).
- A [Swift async main function](SwiftBlink/SwiftBlink.swift), which runs a taskgroup for concurrently blinking an LED and printing the uptime every second.

### Changes to generated source files

The following noteworthy changes are done to the STM32CubeMX generated source files:

- The main function, in [main.c](Core/Src/main.c) generated by STM32CubeMX, has been changed to actually return instead of going into an infinite loop. The function is renamed to Initialize_Hardware. The Initialize_Hardware function is the first thing being called from Swift's async main function in [SwiftBlink.swift](SwiftBlink/SwiftBlink.swift).
- An implementation of __io_putchar is provided in [main.c](Core/Src/main.c), in order to be able to print to the ST-LINK virtual serial port.
- An implementation of HAL_IncTick is provided in [main.c](Core/Src/main.c), in order to forward 1 ms ticks to Swift's [ContinuousClock](SwiftBlink/Support/ContinuousClock.swift).
- Functions for switching LED (LD2) on and off are added to [main.c](Core/Src/main.c).

## Building

### Requirements

To build the project, the following is required:

- cmake
- ninja
- arm-none-eabi toolchain
- Swift 6.2.2 compiler
- newlib

Note: The project has only been tested with the [gcc-arm-none-eabi.cmake](cmake/gcc-arm-none-eabi.cmake) toolchain configuration.

The custom pre-built Swift runtime is built with Ubuntu 24.04 and the newlib packages it provides, so building this project with Ubuntu 24.04 will make sure everything matches. However, other distros/versions may work as well.

### Manual

The following builds the project:

```sh
cmake --preset Debug
cmake --build --preset Debug
```

The resulting 'build/Debug/stm32-blink-hal-async-swift.elf' file can be programmed to the device with the STM32CubeProgrammer.

### VS Code

The VS Code files in the project provide configuration to perform a debug build, upload the result to the device and start a debug session in one go; this is done using openocd. In order to be able to use this set-up, openocd and arm-none-eabi-gdb must be installed.
